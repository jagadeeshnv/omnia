# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Fresh cluster - Include common tasks
  ansible.builtin.include_tasks: common.yml

- name: Install slurm packages
  ansible.builtin.shell: "dnf install -y --installroot={{ installroot }} --setopt=reposdir=/etc/yum.repos.d/ slurm"
  failed_when: false # WARNING failure in the above task, install though error, repos also reset!!
  changed_when: false

- name: NFS slurm conf edit ops !!
  when: (slurm_installation_type == nfs_share_slurm)
  block:
    - name: Check if slurm.conf exists
      ansible.builtin.stat:
        path: "{{ slurm_share_prefix }}{{ slurm_config_dir }}/slurm.conf"
      register: slurm_conf_path

    - name: Fail if slurm.conf does not exist
      ansible.builtin.fail:
        msg: "NFS share slurm conf missing. Please ensure the slurm.conf is created at {{ slurm_share_prefix }}{{ slurm_config_dir }}/slurm.conf"
      when: not slurm_conf_path.stat.exists

    - name: Add controller list in conf if not present
      ansible.builtin.lineinfile:
        path: "{{ slurm_share_prefix }}{{ slurm_config_dir }}/slurm.conf"
        line: "SlurmctldHost={{ item }}"
        insertafter: '^ClusterName=*'
      loop: "{{ ctld_list }}"

    - name: Remove the localhost line
      ansible.builtin.lineinfile:
        path: "{{ slurm_share_prefix }}{{ slurm_config_dir }}/slurm.conf"
        line: "NodeName=localhost"
        state: absent

    - ansible.builtin.debug:
        var: ctld_list

- name: Login node configless
  when: slurm_installation_type == configless_slurm
  block:
    - name: Install compute packages
      ansible.builtin.package:
        name: "{{ slurm_compute_packages[ansible_os_family] }}"
        state: present

    - name: Enable SlurmdPort
      ansible.posix.firewalld:
        port: "{{ item }}/tcp"
        permanent: true
        zone: public
        state: enabled
        immediate: true
      loop:
        - "{{ slurm_conf_dict['SlurmdPort'] }}"

    - name: Enable the service
      ansible.builtin.service:
        name: slurmd
        enabled: true
      register: slurmd_service

    - name: Get service path
      ansible.builtin.set_fact:
        slurmd_service_path: "{{ slurmd_service['status']['FragmentPath'] | default(slurmd_service_default_path) }}"

    - name: Edit the service ConditionPathExists
      community.general.ini_file:
        path: "{{ slurmd_service_path }}"
        section: Unit
        option: ConditionPathExists
        owner: "{{ root_user }}"
        group: "{{ root_group }}"
        mode: "{{ conf_file_mode }}"
        state: absent
      notify:
        - Reload slurmd
        - Restart slurmd
  
    - name: Edit the service ExecStart
      community.general.ini_file:
        path: "{{ slurmd_service_path }}"
        section: Service
        option: ExecStart
        owner: "{{ root_user }}"
        group: "{{ root_group }}"
        mode: "{{ conf_file_mode }}"
        value: "/usr/sbin/slurmd -D
         --conf-server {{ ctld_list | map('regex_replace', '^(.*)$', '\\1:' ~ (slurm_conf_dict['SlurmctldPort'] | string)) | join(',') }} -s $SLURMD_OPTIONS" # HA

    - name: Set ctld specific env file
      community.general.ini_file:
        path: "/etc/sysconfig/slurmd"
        option: "LD_LIBRARY_PATH"
        state: "{{ 'present' if (slurm_installation_type == nfs_share_slurm) else 'absent' }}"
        value: "{{ installroot }}usr/lib64"
        no_extra_spaces: true
        owner: "{{ root_user }}"
        group: "{{ root_group }}"
        mode: "{{ conf_file_mode }}"
      notify:
        - Reload slurmd
        - Restart slurmd

- name: Set the common env vars
  ansible.builtin.include_tasks: _env_set.yml
